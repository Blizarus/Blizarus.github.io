<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chapter</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script>
      // Функция для получения параметра из URL
      function getQueryParam(param) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(param);
      }

      // Подгрузка данных главы
      async function loadChapter() {
        const novelId = getQueryParam("novel");
        const chapterFile = getQueryParam("chapter");

        if (!novelId || !chapterFile) {
          document.getElementById("content").innerHTML =
            "<p class='text-danger'>Chapter not found!</p>";
          return;
        }

        const response = await fetch(
          `novels/${novelId}/chapters/${chapterFile}`
        );
        if (!response.ok) {
          document.getElementById(
            "content"
          ).innerHTML = `<p class='text-danger'>Error loading chapter data for '${chapterFile}'.</p>`;
          return;
        }

        const chapterData = await response.json();
        document.getElementById("title").innerText = chapterData.title;

        const contentDiv = document.getElementById("content");
        chapterData.content.forEach((paragraph) => {
          const p = document.createElement("p");
          p.textContent = paragraph;
          contentDiv.appendChild(p);
        });

        if (chapterData.previous) {
          document.getElementById(
            "prev"
          ).href = `chapter_template.html?novel=${novelId}&chapter=${chapterData.previous}.json`;
          document.getElementById("prev").classList.remove("disabled");
        }
        if (chapterData.next) {
          document.getElementById(
            "next"
          ).href = `chapter_template.html?novel=${novelId}&chapter=${chapterData.next}.json`;
          document.getElementById("next").classList.remove("disabled");
        }

        // Устанавливаем ссылку на страницу новеллы
        document.getElementById(
          "goToNovel"
        ).href = `novel_template.html?novel=${novelId}`;
      }

      // Открытие модального окна с содержанием
      async function loadContents() {
        const novelId = getQueryParam("novel");

        if (!novelId) {
          document.getElementById("content").innerHTML =
            "<p class='text-danger'>Novel not found!</p>";
          return;
        }

        const response = await fetch(`novels/${novelId}/novel.json`);
        if (!response.ok) {
          document.getElementById(
            "content"
          ).innerHTML = `<p class='text-danger'>Error loading novel data for '${novelId}'.</p>`;
          return;
        }

        const novelData = await response.json();
        const chapterList = document.getElementById("chapter-list");
        chapterList.innerHTML = ""; // Очищаем текущий список

        novelData.chapters.forEach((chapter) => {
          const li = document.createElement("li");
          li.className = "list-group-item";
          li.innerHTML = `<a href="chapter_template.html?novel=${novelId}&chapter=${chapter.filename}" class="text-decoration-none">${chapter.title}</a>`;
          chapterList.appendChild(li);
        });

        // Открываем модальное окно
        const contentModal = new bootstrap.Modal(
          document.getElementById("contentModal")
        );
        contentModal.show();
      }

      document.addEventListener("DOMContentLoaded", loadChapter);
    </script>
  </head>
  <body class="container my-5">
    <h1 id="title">Loading...</h1>
    <div id="content"></div>
    <nav class="my-4">
      <a id="prev" href="#" class="btn btn-primary disabled"
        >&laquo; Previous</a
      >

      <!-- Кнопка для открытия содержания -->
      <button class="btn btn-info my-3" onclick="loadContents()">
        Table of Contents
      </button>

      <!-- Модальное окно с содержанием -->
      <div
        class="modal fade"
        id="contentModal"
        tabindex="-1"
        aria-labelledby="contentModalLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="contentModalLabel">
                Table of Contents
              </h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
            <div class="modal-body">
              <ul id="chapter-list" class="list-group">
                <!-- Здесь будет список глав -->
              </ul>
            </div>
          </div>
        </div>
      </div>

      <!-- Кнопки перехода между главами -->

      <!-- Кнопка для перехода на страницу новеллы -->
      <a id="goToNovel" href="#" class="btn btn-secondary mx-2">Go to Novel</a>

      <a id="next" href="#" class="btn btn-primary disabled">Next &raquo;</a>
    </nav>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
